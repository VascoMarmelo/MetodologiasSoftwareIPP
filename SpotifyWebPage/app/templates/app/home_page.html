{% extends 'app/base_page.html' %}

<!--Corpo do perfil-->
{% block content %}

    <div class="container d-flex justify-content-center" ng-controller="myCtrlHomeApp">
        <button class="btn btn-primary " ng-click="loginCallBack()">Login Btn</button>
    
    
    
    </div>      

    <script>
        app.controller('myCtrlHomeApp', function($scope, $interval, $http){
            //Javascript

            //id de serviço
            $scope.client_id = '82317a0473474f8d944323a93d488939';

            //Documentação do Spotify
            $scope.loginCallBack = function(){
                const generateRandomString = (length) => {
                    const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                    const values = crypto.getRandomValues(new Uint8Array(length));
                    return values.reduce((acc, x) => acc + possible[x % possible.length], "");
                }

                const sha256 = async (plain) => {
                    const encoder = new TextEncoder()
                    const data = encoder.encode(plain)
                    return window.crypto.subtle.digest('SHA-256', data)
                }
                const base64encode = (input) => {
                    return btoa(String.fromCharCode(...new Uint8Array(input)))
                    .replace(/=/g, '')
                    .replace(/\+/g, '-')
                    .replace(/\//g, '_');
                }

                const codeVerifier  = generateRandomString(64);
                const hashed = sha256(codeVerifier)
                const codeChallenge = base64encode(hashed);


                const clientId = '82317a0473474f8d944323a93d488939';
                const redirectUri = 'http://127.0.0.1:8000/perfil';
                const scope = 'user-read-private user-read-email';
                const authUrl = new URL("https://accounts.spotify.com/authorize");

                // generated in the previous step
                window.localStorage.setItem('code_verifier', codeVerifier);

                const params =  {
                    response_type: 'code',
                    client_id: clientId,
                    scope,
                    code_challenge_method: 'S256',
                    code_challenge: codeChallenge,
                    redirect_uri: redirectUri,
                }

                authUrl.search = new URLSearchParams(params).toString();
                window.location.href = authUrl.toString();
            }
        });
    </script>

{% endblock %}