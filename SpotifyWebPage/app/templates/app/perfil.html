{% extends 'app/base_page.html' %}

<!--Corpo do perfil-->
{% block content %}

    <div class="container" ng-controller="myCtrlPerfil">
        {{userData}}
    </div>      

    <script>
        app.controller('myCtrlPerfil', function($scope, $interval, $http, $location){
            //Javascript

            //No url, depois de fazer login, est√° o code que tem de ser usado no parametro do get
            $scope.client_id = '82317a0473474f8d944323a93d488939';
            $scope.code = window.location.search;
            $scope.code = $scope.code.split('=')[1];
            $scope.accessToken = '';

            
            
            $scope.getUserData = function(){
                $http({
                    method: 'GET',
                    url: 'https://api.spotify.com/v1/me',
                    headers: {Authorization: 'Bearer ' + $scope.code},
                }).then(function successCallback(response) {
                    // Gere resposta, em caso de sucesso
                    $scope.userData = response.data; // Access the response data here
                    console.log($scope.userData);
                    
                }, function errorCallback(error) {
                    // Gere resposta, em caso de falha
                    console.error('Error fetching data:', error);
                });
            }

            $scope.getToken = async function() {
                const getToken = async function() {

                    const clientId = '82317a0473474f8d944323a93d488939';
                    const redirectUri = 'http://127.0.0.1:8000/perfil';

                    // stored in the previous step
                    let codeVerifier = window.localStorage.getItem('code_verifier');
                    console.log(codeVerifier);

                    const payload = {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            client_id: clientId,
                            grant_type: 'authorization_code',
                            code: $scope.code,
                            redirect_uri: redirectUri,
                            code_verifier: codeVerifier,
                        }),
                    }

                    const body = await fetch('https://accounts.spotify.com/api/token', payload);
                    const response = await body.json();

                    localStorage.setItem('access_token', response.access_token);
                }

                $scope.accessToken = await getToken();
                console.log($scope.accessToken);


            }
            
            $scope.getToken();



        });

            


    </script>





{% endblock %}