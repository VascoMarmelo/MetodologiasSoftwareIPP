{% extends 'app/base_page.html' %}
{% load static %}


<!--Corpo do perfil-->
{% block navbar %}
    <div ng-controller="myCtrlPerfil">
        <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: #545454;">
            <div class="container-fluid">
                <img src="{% static 'MADS.jpg' %}" width="40" height="40" alt="MADS Logo">
                <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
                    <div class="navbar-nav">
                        <a class="nav-link" href="{% url 'app_profile' %}">Perfil</a>
                    </div>
                </div>
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <span class="nav-link">Utilizador: {% verbatim %} {{userData.display_name}}  {% endverbatim %}  </span>
                    </li>
                    <li class="nav-item">
                        <span class="nav-link logout-button" ng-click="logout()">LOGOUT</span>
                    </li>
                </ul>
            </div>
        </nav>

{% endblock %}


{% block script %}
    <script>
        app.controller('myCtrlPerfil', function($scope, $interval, $http, $location){
            //Javascript

            //Inicialização de variaveis
            $scope.client_id = window.localStorage.getItem('client_id');
            $scope.code = window.location.search.split('=')[1];
            $scope.accessToken = '';
            $scope.userData = {};

            $scope.logout = function(){
                window.location.href = "/";
            }

            $scope.getUserData = function(){
                $http({
                    method: 'GET',
                    url: 'https://api.spotify.com/v1/me',
                    headers: { Authorization: 'Bearer ' + $scope.accessToken },
                }).then(function successCallback(response) {
                    $scope.userData = response.data;
                    console.log($scope.userData);
                }, function errorCallback(error) {
                    console.error('Error fetching data:', error);
                });
            };

            $scope.getArtist = function(){
                $http({
                    method: 'GET',
                    url: 'https://api.spotify.com/v1/me/following',
                    params: { type: 'artist' },
                    headers: { Authorization: 'Bearer ' + $scope.accessToken },
                }).then(function successCallback(response) {
                    $scope.userArtist = response.data;
                    console.log($scope.userArtist);
                }, function errorCallback(error) {
                    console.error('Error fetching data:', error);
                });
            };

            $scope.getRespChat = function(){
                $http({
                    method: 'GET',
                    url: 'https://api.spotify.com/v1/search',
                    headers: { Authorization: 'Bearer ' + $scope.accessToken },
                    params: { type: 'artist' },
                }).then(function successCallback(response) {
                    $scope.chatbot = response.data;
                    console.log($scope.chatbot);
                }, function errorCallback(error) {
                    console.error('Error fetching data:', error);
                });
            };

            $scope.getPlayList = function(){
                $http({
                    method: 'GET',
                    url: 'https://api.spotify.com/v1/browse/featured-playlists',
                    headers: { Authorization: 'Bearer ' + $scope.accessToken },
                }).then(function successCallback(response) {
                    $scope.playList = response.data;
                    console.log($scope.playList);
                }, function errorCallback(error) {
                    console.error('Error fetching data:', error);
                });
            };

            $scope.getRecommendations = function(options){
                const { seed_artists, seed_genres, seed_tracks, limit, market, min_energy, max_energy } = options;

                const params = {
                    limit: limit || 20,
                    market: market || 'BR',
                    seed_artists: seed_artists || '',
                    seed_genres: seed_genres || '',
                    seed_tracks: seed_tracks || '',
                    min_energy: min_energy || 0.0,
                    max_energy: max_energy || 1.0,
                };

                $http({
                    method: 'GET',
                    url: 'https://api.spotify.com/v1/recommendations',
                    headers: { Authorization: 'Bearer ' + $scope.accessToken },
                    params: params
                }).then(function successCallback(response) {
                    $scope.recommendations = response.data.tracks;
                    displayRecommendations($scope.recommendations);
                }, function errorCallback(error) {
                    console.error('Error fetching recommendations:', error);
                });
            };

            function displayRecommendations(tracks) {
                const recommendationsDiv = document.getElementById('recommendations');
                recommendationsDiv.innerHTML = '';

                tracks.forEach(track => {
                    const trackElement = document.createElement('div');
                    trackElement.classList.add('recommendation');
                    trackElement.innerHTML = `
                        <p><strong>Track:</strong> ${track.name}</p>
                        <p><strong>Artist:</strong> ${track.artists.map(artist => artist.name).join(', ')}</p>
                        <p><strong>Album:</strong> ${track.album.name}</p>
                        <a href="${track.external_urls.spotify}" target="_blank">Listen on Spotify</a>
                    `;
                    recommendationsDiv.appendChild(trackElement);
                });
            }

            $scope.getToken = async function() {
                const clientId = window.localStorage.getItem('client_id');
                const redirectUri = window.localStorage.getItem('redirectUri');

                if (!window.localStorage.getItem('refresh_token')) {
                    let codeVerifier = window.localStorage.getItem('code_verifier');
                    const payload = {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            client_id: clientId,
                            grant_type: 'authorization_code',
                            code: $scope.code,
                            redirect_uri: redirectUri,
                            code_verifier: codeVerifier,
                        }),
                    };

                    const body = await fetch('https://accounts.spotify.com/api/token', payload);
                    const response = await body.json();
                    window.localStorage.setItem('access_token', response.access_token);
                    window.localStorage.setItem('refresh_token', response.refresh_token);
                    $scope.accessToken = response.access_token;
                } else {
                    const refreshToken = window.localStorage.getItem('refresh_token');
                    const url = "https://accounts.spotify.com/api/token";

                    const payload = {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: new URLSearchParams({
                            grant_type: 'refresh_token',
                            refresh_token: refreshToken,
                            client_id: clientId
                        }),
                    };

                    const body = await fetch(url, payload);
                    const response = await body.json();
                    window.localStorage.setItem('access_token', response.access_token);
                    window.localStorage.setItem('refresh_token', response.refresh_token);
                    $scope.accessToken = response.access_token;
                }
            };

            $scope.getToken().then(function(){
                $scope.getUserData();
                $scope.getPlayList();
                $scope.getArtist();
                $scope.getRespChat();

                // Chamando a função getRecommendations com opções de exemplo
                const options = {
                    seed_artists: '4NHQUGzhtTLFvgF5SZesLK',
                    seed_genres: 'pop',
                    seed_tracks: '0c6xIDDpzE81m2q797ordA',
                    limit: 12,
                    market: 'BR',
                    min_energy: 0.4,
                    max_energy: 0.8
                };
                $scope.getRecommendations(options);
            });
        });
    </script>
{% endblock %}

{% block html %}

<div class="container">
    <div class="column2">
        <h1>MÚSICAS RECOMENDADAS</h1>
        <section class="section">
            <div id="recommendations">
                <!-- Recomendações serão inseridas aqui -->
            </div>
        </section>
    </div>
</div>

<style>
    .recommendation + .recommendation {
        margin-top: 20px; /* Espaço entre recomendações */
    }
    .recommendation p, .recommendation a {
        color: white; /* Altera a cor da fonte para branco */
    }
    .recommendation {
        background-color: #333; /* Cor de fundo do card */
        padding: 20px; /* Espaçamento interno do card */
        border-radius: 10px; /* Bordas arredondadas */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* Sombra do card */
    }
    .recommendation a {
        color: #FF914D; /* Altera a cor do link para laranja */
    }
</style>

<script>
    // Código JavaScript para exibir recomendações de faixas
    const recommendationsDiv = document.getElementById('recommendations');
    tracks.forEach(track => {
        const trackElement = document.createElement('div');
        trackElement.classList.add('recommendation');
        trackElement.innerHTML = `
            <div class="card-content">
                <p><strong>Track:</strong> ${track.name}</p>
                <p><strong>Artist:</strong> ${track.artists.map(artist => artist.name).join(', ')}</p>
                <p><strong>Album:</strong> ${track.album.name}</p>
                <a href="${track.external_urls.spotify}" target="_blank">Listen on Spotify <img src=“https://storage.googleapis.com/pr-newsroom-wp/1/2023/05/Spotify_Primary_Logo_RGB_Green.png”></a>
            </div>
        `;
        recommendationsDiv.appendChild(trackElement);
    });
</script>

{% endblock %}